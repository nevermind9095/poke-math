<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¯¶å¯å¤¢æ•¸å­¸å¤§å¸« - ç•°åˆ†æ¯åˆ†æ•¸ (æœ€çµ‚å®Œç¾ç‰ˆ)</title>
    <style>
        :root {
            --poke-red: #FF3E3E;
            --poke-dark-red: #CC0000;
            --poke-white: #FFFFFF;
            --poke-black: #2D2D2D;
            --poke-yellow: #FFCB05;
            --poke-blue: #3B4CCA;
            --bg-color: #F0F0F0;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            font-family: "Microsoft JhengHei", "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
        }

        body {
            background-color: #333;
            background-image: linear-gradient(rgba(0,0,0,0.5) 1px, transparent 1px),
            linear-gradient(90deg, rgba(0,0,0,0.5) 1px, transparent 1px);
            background-size: 20px 20px;
            color: var(--poke-black);
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* éŠæˆ²æ©Ÿå¤–æ¡† */
        .pokedex-container {
            width: 100%;
            max-width: 800px;
            background-color: var(--poke-red);
            border-radius: 20px;
            padding: 15px;
            box-shadow: 0 5px 0 var(--poke-dark-red), 0 10px 10px rgba(0,0,0,0.5);
            position: relative;
            margin-bottom: 15px;
            border: 4px solid var(--poke-black);
        }

        /* é ‚éƒ¨æ§åˆ¶åˆ— */
        .top-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .lights-left {
            display: flex;
            align-items: start;
            gap: 10px;
        }

        /* å³ä¸Šè§’æ§åˆ¶å€ç¾¤çµ„ (ä¿®æ­£é‡ç–Šå•é¡Œ) */
        .top-right-group {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .camera-lens {
            width: 50px;
            height: 50px;
            background: radial-gradient(circle at 30% 30%, #4DEEEE, #0099CC);
            border-radius: 50%;
            border: 4px solid white;
            box-shadow: 0 0 10px #4DEEEE;
            position: relative;
        }
        
        .camera-lens::after {
            content: '';
            position: absolute;
            top: 10px; left: 10px;
            width: 15px; height: 15px;
            background: white;
            border-radius: 50%;
            opacity: 0.6;
        }

        .small-lights {
            display: flex;
            gap: 5px;
            padding-top: 5px;
        }
        .light {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            border: 2px solid rgba(0,0,0,0.3);
            box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
        }
        .light.red { background-color: #FF0000; }
        .light.yellow { background-color: #FFFF00; }
        .light.green { background-color: #00FF00; }

        /* éŸ³æ¨‚æŒ‰éˆ•æ¨£å¼ */
        .music-btn {
            background: #222;
            color: #4DEEEE;
            border: 2px solid #444;
            border-radius: 20px; /* åœ“è§’ä¸€è‡´ */
            padding: 6px 12px;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            box-shadow: inset 0 0 5px #000;
            white-space: nowrap;
        }
        .music-btn.active {
            background: #4DEEEE;
            color: #222;
            box-shadow: 0 0 10px #4DEEEE;
        }
        
        /* é›²ç«¯ç‹€æ…‹åˆ— (ä¿®æ­£æ¨£å¼) */
        .cloud-status {
            /* ç§»é™¤åŸæœ¬çš„ absolute å®šä½ */
            font-size: 0.8rem;
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0, 0, 0, 0.2); /* å¢åŠ åº•è‰² */
            padding: 4px 10px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .status-dot {
            width: 8px; height: 8px; border-radius: 50%; background: #999;
        }
        .status-dot.online { background: #00FF00; box-shadow: 0 0 5px #00FF00; }

        /* é›²ç«¯ç™»å…¥æŒ‰éˆ• */
        .auth-btn {
            background: #444;
            color: white;
            border: 1px solid #fff;
            border-radius: 4px;
            padding: 2px 8px;
            font-size: 0.75rem;
            cursor: pointer;
            margin-left: 5px;
        }
        .auth-btn.logged-in {
            background: #4caf50;
            border-color: #81c784;
        }

        /* è¢å¹•å€ */
        .screen-border {
            background-color: #DEDEDE;
            border-radius: 10px 10px 40px 10px;
            padding: 20px;
            border: 3px solid var(--poke-black);
            box-shadow: inset 0 0 10px rgba(0,0,0,0.2);
        }

        .battle-screen {
            background-color: #F8F8F8;
            background-image: linear-gradient(to bottom, #ffffff, #e0f0ff);
            border: 3px solid var(--poke-black);
            border-radius: 8px;
            padding: 10px;
            min-height: 280px;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            overflow: hidden;
        }

        .mistake-indicators {
            position: absolute; top: 10px; left: 10px; display: flex; gap: 5px; z-index: 10;
        }
        .mistake-dot {
            width: 12px; height: 12px; border-radius: 50%; background: rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.2);
        }
        .mistake-dot.active { background: #FF0000; box-shadow: 0 0 5px red; }

        .pokemon-display {
            position: relative; width: 100%; height: 180px; display: flex; justify-content: center; align-items: center; margin-top: 10px;
        }

        .pokemon-img {
            width: 160px; height: 160px; image-rendering: pixelated; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2)); transition: all 0.5s ease; z-index: 2;
        }
        .pokemon-img.silhouette { filter: brightness(0) grayscale(100%); opacity: 0.8; }
        .pokemon-img.run-away { animation: runAway 0.8s forwards; }
        .pokemon-img.captured { animation: captureAnim 1s forwards; }

        @keyframes runAway { 0% { transform: translateX(0) scale(1); opacity: 1; } 100% { transform: translateX(-300px) scale(0.5); opacity: 0; } }
        @keyframes captureAnim { 0% { transform: scale(1); filter: brightness(10); } 100% { transform: scale(0); opacity: 0; } }

        .pokeball-throw {
            position: absolute; width: 40px; height: 40px; background: url('https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png') no-repeat center/contain; z-index: 10; display: none;
        }

        .battle-platform {
            position: absolute; bottom: 15px; width: 200px; height: 60px; background: rgba(0,0,0,0.1); border-radius: 50%; transform: scaleY(0.4); z-index: 1;
        }

        .problem-float {
            background: rgba(255,255,255,0.95); border: 3px solid var(--poke-black); border-radius: 10px; padding: 8px 20px; position: absolute; top: 10px; right: 5px; font-weight: bold; font-size: 1.8rem; display: flex; align-items: center; gap: 5px; box-shadow: 3px 3px 0 rgba(0,0,0,0.2); z-index: 5;
        }

        .control-panel {
            background-color: var(--poke-black); color: white; padding: 15px; border-radius: 0 0 15px 15px; min-height: 160px; display: flex; flex-direction: column; justify-content: space-between; border-left: 5px solid var(--poke-dark-red); border-right: 5px solid var(--poke-dark-red); border-bottom: 5px solid var(--poke-dark-red);
        }

        .dialog-box {
            border: 3px solid #eee; border-radius: 8px; padding: 10px; font-size: 1.1rem; line-height: 1.4; margin-bottom: 10px; background: #222; color: white; min-height: 75px; font-family: "Courier New", Courier, monospace;
        }

        .action-buttons { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; }

        .btn-action {
            background: #f8f8f8; color: var(--poke-black); border: 3px solid #666; padding: 12px 10px; font-size: 1rem; font-weight: bold; border-radius: 8px; cursor: pointer; transition: all 0.1s; min-width: 100px; flex: 1; max-width: 48%; touch-action: manipulation;
        }
        .btn-action:active { background: var(--poke-yellow); border-color: #B8860B; transform: scale(0.96); }

        .input-mode-container {
            display: flex; align-items: center; gap: 10px; justify-content: center; background: #ddd; padding: 10px; border-radius: 10px; color: black; border: 3px solid #555; flex-wrap: wrap;
        }

        input[type="number"] {
            width: 60px; height: 45px; font-size: 1.3rem; text-align: center; border: 2px solid var(--poke-black); border-radius: 5px; font-weight: bold;
        }
        input[type="number"]:focus { outline: none; background-color: #e0f7fa; border-color: var(--poke-blue); }

        .fraction { display: inline-flex; flex-direction: column; align-items: center; vertical-align: middle; margin: 0 2px; color: black; font-weight: bold; }
        .numerator { border-bottom: 2px solid black; width: 100%; text-align: center; padding-bottom:2px; }
        .denominator { width: 100%; text-align: center; padding-top:2px; }

        .pc-box {
            width: 100%; max-width: 800px; background: white; border: 4px solid var(--poke-black); border-radius: 15px; padding: 15px; margin-top: 15px; position: relative;
        }
        .pc-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; border-bottom: 2px solid #eee; padding-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
        .pokemon-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 5px; max-height: 300px; overflow-y: auto; padding: 5px; }
        .grid-item { background: #eee; border-radius: 8px; padding: 3px; text-align: center; border: 1px solid #ccc; transition: all 0.3s; aspect-ratio: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .grid-item.unknown img { filter: brightness(0); opacity: 0.3; }
        .grid-item.caught { border-color: var(--poke-yellow); background: #FFFDE7; }
        .grid-item.caught img { filter: none; }
        .grid-item img { width: 90%; height: auto; }
        .grid-item .name-tag { font-size: 0.6rem; margin-top: 2px; font-weight: bold; color: #555; }

        .victory-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; display: none; flex-direction: column; justify-content: center; align-items: center; color: white; text-align: center; animation: fadeIn 1s;
        }
        .badge-img {
            width: 150px; height: 150px; background: radial-gradient(circle, gold, orange); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 4rem; border: 5px solid white; box-shadow: 0 0 30px gold; margin: 20px; animation: spin 10s linear infinite;
        }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .shake-anim { animation: shake 0.5s; }
        .bounce { animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

    </style>
</head>
<body>

    <div class="victory-modal" id="victoryModal">
        <h1>ğŸ‘‘ æ­å–œæˆç‚ºå¯¶å¯å¤¢æ•¸å­¸å¤§å¸«ï¼</h1>
        <div class="badge-img">ğŸ†</div>
        <h2>ä½ å·²ç¶“æ”¶æœäº†æ‰€æœ‰ 100 éš»å¯¶å¯å¤¢ï¼</h2>
        <button class="btn-action" onclick="location.reload()">é‡æ–°é–‹å§‹å†’éšª</button>
    </div>

    <div class="pokedex-container">
        
        <div class="top-bar">
            <div class="lights-left">
                <div class="camera-lens"></div>
                <div class="small-lights">
                    <div class="light red"></div>
                    <div class="light yellow"></div>
                    <div class="light green"></div>
                </div>
            </div>
            
            <div class="top-right-group">
                <div class="cloud-status">
                    <div class="status-dot" id="cloudStatusDot"></div>
                    <span id="cloudStatusText">é›¢ç·šæ¨¡å¼</span>
                    <button id="authBtn" class="auth-btn" onclick="toggleAuth()">ç™»å…¥</button>
                </div>
                <div class="music-btn" id="musicToggle" onclick="toggleMusic()">
                    ğŸµ BGM: OFF
                </div>
            </div>
        </div>

        <div class="screen-border">
            <div class="battle-screen">
                <div class="mistake-indicators">
                    <div class="mistake-dot" id="mistake1"></div>
                    <div class="mistake-dot" id="mistake2"></div>
                </div>

                <div class="pokemon-display">
                    <div class="battle-platform"></div>
                    <img id="pokemonImg" src="" class="pokemon-img silhouette bounce" alt="Pokemon">
                    <div id="pokeballThrow" class="pokeball-throw"></div>
                </div>

                <div class="problem-float" id="problemCard" style="display:none;"></div>
            </div>

            <div class="control-panel">
                <div class="dialog-box" id="dialogBox">ç³»çµ±å•Ÿå‹•ä¸­...</div>
                <div class="action-buttons" id="actionArea"></div>
            </div>
        </div>
    </div>

    <div class="pc-box">
        <div class="pc-title">
            <span>ğŸ“¦ å¯¶å¯å¤¢ç›’å­</span>
            <span>å®Œæˆåº¦: <span id="caughtCount">0</span>/100</span>
        </div>
        <div class="pokemon-grid" id="pcGrid"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDJFzG3RrCkJBx5B23lBVcoOHmaqZ2dAYA",
            authDomain: "forgemini-7349a.firebaseapp.com",
            projectId: "forgemini-7349a",
            storageBucket: "forgemini-7349a.firebasestorage.app",
            messagingSenderId: "865250968546",
            appId: "1:865250968546:web:fc3ded71179b709d422fbb"
        };

        window.Cloud = {
            db: null,
            user: null,
            auth: null,
            appId: 'poke-math-default',
            
            init: async () => {
                try {
                    const app = initializeApp(firebaseConfig);
                    window.Cloud.auth = getAuth(app);
                    window.Cloud.db = getFirestore(app);
                    const provider = new GoogleAuthProvider();
                    
                    onAuthStateChanged(window.Cloud.auth, (u) => {
                        window.Cloud.user = u;
                        const btn = document.getElementById('authBtn');
                        const statusText = document.getElementById('cloudStatusText');
                        const statusDot = document.getElementById('cloudStatusDot');

                        if (u) {
                            statusDot.classList.add('online');
                            // åå­—å¤ªé•·å¯ä»¥æˆªæ–·ï¼Œé¿å…ç ´ç‰ˆ
                            statusText.innerText = `${u.displayName.substring(0,6)}`;
                            btn.innerText = "ç™»å‡º";
                            btn.classList.add('logged-in');
                            window.Cloud.load(); 
                        } else {
                            statusDot.classList.remove('online');
                            statusText.innerText = "é›¢ç·š";
                            btn.innerText = "ç™»å…¥";
                            btn.classList.remove('logged-in');
                        }
                    });

                    window.toggleAuth = async () => {
                        if (window.Cloud.user) {
                            await signOut(window.Cloud.auth);
                            location.reload();
                        } else {
                            try {
                                await signInWithPopup(window.Cloud.auth, provider);
                            } catch(e) {
                                alert("ç™»å…¥å¤±æ•—: " + e.message);
                            }
                        }
                    };

                } catch (e) {
                    console.error("Cloud Init Error:", e);
                    document.getElementById('cloudStatusText').innerText = "é€£ç·šç•°å¸¸";
                }
            },

            save: async (caughtArray) => {
                if (!window.Cloud.db || !window.Cloud.user) return;
                try {
                    const path = `artifacts/${window.Cloud.appId}/users/${window.Cloud.user.uid}/game_data`;
                    await setDoc(doc(window.Cloud.db, path, 'saveFile'), { 
                        caughtList: caughtArray,
                        lastUpdated: serverTimestamp() 
                    });
                } catch (e) {
                    console.error("Save Failed:", e);
                }
            },

            load: () => {
                if (!window.Cloud.db || !window.Cloud.user) return;
                const path = `artifacts/${window.Cloud.appId}/users/${window.Cloud.user.uid}/game_data`;
                onSnapshot(doc(window.Cloud.db, path, 'saveFile'), (snap) => {
                    if (snap.exists()) {
                        const data = snap.data();
                        if (data && data.caughtList) {
                            window.caughtPokemon = new Set(data.caughtList);
                            localStorage.setItem('poke_math_save_v2', JSON.stringify(data.caughtList));
                            if (typeof window.renderPC === 'function') window.renderPC();
                        }
                    }
                });
            }
        };
        
        window.Cloud.init();
    </script>

    <script>
        // éŸ³æ•ˆç³»çµ±
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let isMusicOn = false;
        let nextNoteTime = 0;
        let noteIndex = 0;
        let bgmTimerID = null;

        const Notes = {
            'G2': 98.00, 'G#2': 103.83, 'A2': 110.00, 'A#2': 116.54, 'B2': 123.47,
            'C3': 130.81, 'C#3': 138.59, 'D3': 146.83, 'D#3': 155.56, 'E3': 164.81, 'F3': 174.61, 'F#3': 185.00, 'G3': 196.00, 'G#3': 207.65, 'A3': 220.00, 'A#3': 233.08, 'B3': 246.94,
            'C4': 261.63, 'C#4': 277.18, 'D4': 293.66, 'D#4': 311.13, 'E4': 329.63, 'F4': 349.23, 'F#4': 369.99, 'G4': 392.00, 'G#4': 415.30, 'A4': 440.00, 'A#4': 466.16, 'B4': 493.88,
            'C5': 523.25, 'C#5': 554.37, 'D5': 587.33, 'D#5': 622.25, 'E5': 659.25, 'F5': 698.46, 'F#5': 739.99, 'G5': 783.99, 'G#5': 830.61, 'A5': 880.00,
            'C6': 1046.50, 'G5': 783.99, 'F#5': 739.99, 'F5': 698.46, 'E5': 659.25, 'D#5': 622.25, 'D5': 587.33, 'C#5': 554.37
        };

        const SongData = {
            tempo: 180, 
            intro: [
                {n: 'G5', d: 0.06}, {n: 'F#5', d: 0.06}, {n: 'F5', d: 0.06}, {n: 'E5', d: 0.06},
                {n: 'D#5', d: 0.06}, {n: 'D5', d: 0.06}, {n: 'C#5', d: 0.06}, {n: 'C5', d: 0.06},
                {n: 'B4', d: 0.06}, {n: 'A#4', d: 0.06}, {n: 'A4', d: 0.06}, {n: 'G#4', d: 0.06},
                {n: 'G4', d: 0.125}, {n: 'G4', d: 0.125}, {n: 'G4', d: 0.125}, {n: 'G4', d: 0.125},
                {n: 'G4', d: 0.125}, {n: 'G4', d: 0.125}, {n: 'G4', d: 0.125}, {n: 'G4', d: 0.125},
            ],
            loop: [
                {n: 'G2', d: 0.125, type: 'square'}, {n: 'G2', d: 0.125, type: 'square'}, {n: 'G3', d: 0.125, type: 'square'}, {n: 'G2', d: 0.125, type: 'square'},
                {n: 'G2', d: 0.125, type: 'square'}, {n: 'G2', d: 0.125, type: 'square'}, {n: 'G3', d: 0.125, type: 'square'}, {n: 'G2', d: 0.125, type: 'square'},
                {n: 'C4', d: 0.125, type: 'sawtooth'}, {n: 'A#3', d: 0.125, type: 'sawtooth'}, {n: 'A3', d: 0.125, type: 'sawtooth'}, {n: 'G#3', d: 0.125, type: 'sawtooth'},
                {n: 'G2', d: 0.125, type: 'square'}, {n: 'G2', d: 0.125, type: 'square'}, {n: 'G2', d: 0.125, type: 'square'}, {n: 'G2', d: 0.125, type: 'square'},
                {n: 'C5', d: 0.125, type: 'sawtooth'}, {n: 'B4', d: 0.125, type: 'sawtooth'}, {n: 'A#4', d: 0.125, type: 'sawtooth'}, {n: 'A4', d: 0.125, type: 'sawtooth'},
                {n: 'G#4', d: 0.125, type: 'sawtooth'}, {n: 'G4', d: 0.125, type: 'sawtooth'}, {n: 'F#4', d: 0.125, type: 'sawtooth'}, {n: 'F4', d: 0.125, type: 'sawtooth'},
            ]
        };

        const RetroBGM = {
            isPlaying: false,
            currentSection: 'intro',
            currentIndex: 0,
            
            play: () => {
                if (RetroBGM.isPlaying) return;
                RetroBGM.isPlaying = true;
                RetroBGM.currentSection = 'intro';
                RetroBGM.currentIndex = 0;
                nextNoteTime = audioCtx.currentTime + 0.1;
                RetroBGM.scheduler();
            },

            scheduler: () => {
                if (!RetroBGM.isPlaying) return;
                while (nextNoteTime < audioCtx.currentTime + 0.1) {
                    RetroBGM.scheduleNote();
                }
                bgmTimerID = setTimeout(RetroBGM.scheduler, 25);
            },

            scheduleNote: () => {
                const section = SongData[RetroBGM.currentSection];
                const noteData = section[RetroBGM.currentIndex];
                if (noteData) {
                    const freq = Notes[noteData.n];
                    const type = noteData.type || 'square';
                    const volume = type === 'sawtooth' ? 0.05 : 0.08;
                    playOscillator(freq, type, noteData.d, nextNoteTime, volume);
                    const secondsPerBeat = 60.0 / SongData.tempo;
                    nextNoteTime += noteData.d * secondsPerBeat * 4;
                    RetroBGM.currentIndex++;
                } else {
                    if (RetroBGM.currentSection === 'intro') {
                        RetroBGM.currentSection = 'loop';
                        RetroBGM.currentIndex = 0;
                    } else {
                        RetroBGM.currentIndex = 0;
                    }
                }
            },

            stop: () => {
                RetroBGM.isPlaying = false;
                clearTimeout(bgmTimerID);
            }
        };

        function playOscillator(freq, type, durationNote, time, vol) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.value = freq;
            gain.gain.setValueAtTime(vol, time);
            gain.gain.exponentialRampToValueAtTime(0.01, time + (durationNote * 60/SongData.tempo * 4) * 0.8);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start(time);
            osc.stop(time + (durationNote * 60/SongData.tempo * 4));
        }

        const Sound = {
            playTone: (freq, type, duration, time = 0, vol = 0.1) => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, audioCtx.currentTime + time);
                gain.gain.setValueAtTime(0, audioCtx.currentTime + time);
                gain.gain.linearRampToValueAtTime(vol, audioCtx.currentTime + time + 0.01);
                gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + time + duration);
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start(audioCtx.currentTime + time);
                osc.stop(audioCtx.currentTime + time + duration);
            },
            playCorrect: () => { Sound.playTone(600, 'sine', 0.1, 0); Sound.playTone(1200, 'sine', 0.2, 0.1); },
            playWrong: () => { Sound.playTone(150, 'sawtooth', 0.3, 0); Sound.playTone(100, 'sawtooth', 0.3, 0.2); },
            playThrow: () => {
                const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
                osc.frequency.setValueAtTime(800, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.3);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime); gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.3);
                osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.3);
            },
            playCaught: () => {
                [523, 659, 784, 1046, 1318].forEach((f, i) => Sound.playTone(f, 'square', 0.1, i*0.08, 0.1));
                Sound.playTone(1046, 'square', 0.4, 0.4, 0.1);
            },
            playRunAway: () => {
                Sound.playTone(600, 'sawtooth', 0.1, 0); Sound.playTone(400, 'sawtooth', 0.1, 0.2);
            }
        };

        function toggleMusic() {
            isMusicOn = !isMusicOn;
            const btn = document.getElementById('musicToggle');
            if (audioCtx.state === 'suspended') audioCtx.resume();
            if (isMusicOn) {
                btn.innerText = "ğŸµ BGM: ON";
                btn.classList.add('active');
                if (document.getElementById('problemCard').style.display !== 'none') {
                    RetroBGM.play();
                }
            } else {
                btn.innerText = "ğŸµ BGM: OFF";
                btn.classList.remove('active');
                RetroBGM.stop();
            }
        }

        const CURATED_POKEMON = [
            {id: 1, name: "å¦™è›™ç¨®å­"}, {id: 4, name: "å°ç«é¾"}, {id: 6, name: "å™´ç«é¾"}, {id: 7, name: "å‚‘å°¼é¾œ"}, {id: 9, name: "æ°´ç®­é¾œ"}, {id: 25, name: "çš®å¡ä¸˜"}, {id: 39, name: "èƒ–ä¸"}, {id: 52, name: "å–µå–µ"}, {id: 54, name: "å¯é”é´¨"}, {id: 59, name: "é¢¨é€Ÿç‹—"}, {id: 63, name: "å‡±è¥¿"}, {id: 68, name: "æ€ªåŠ›"}, {id: 94, name: "è€¿é¬¼"}, {id: 129, name: "é¯‰é­šç‹"}, {id: 130, name: "æš´é¯‰é¾"}, {id: 131, name: "æ‹‰æ™®æ‹‰æ–¯"}, {id: 132, name: "ç™¾è®Šæ€ª"}, {id: 133, name: "ä¼Šå¸ƒ"}, {id: 134, name: "æ°´ä¼Šå¸ƒ"}, {id: 135, name: "é›·ä¼Šå¸ƒ"}, {id: 136, name: "ç«ä¼Šå¸ƒ"}, {id: 143, name: "å¡æ¯”ç¸"}, {id: 149, name: "å¿«é¾"}, {id: 150, name: "è¶…å¤¢"}, {id: 151, name: "å¤¢å¹»"},
            {id: 152, name: "èŠè‰è‘‰"}, {id: 155, name: "ç«çƒé¼ "}, {id: 158, name: "å°é‹¸é±·"}, {id: 175, name: "æ³¢å…‹æ¯”"}, {id: 196, name: "å¤ªé™½ä¼Šå¸ƒ"}, {id: 197, name: "æœˆäº®ä¼Šå¸ƒ"}, {id: 202, name: "æœç„¶ç¿"}, {id: 212, name: "å·¨é‰—è³è‚"}, {id: 248, name: "ç­åŸºæ‹‰æ–¯"}, {id: 249, name: "æ´›å¥‡äº"}, {id: 250, name: "é³³ç‹"},
            {id: 252, name: "æœ¨å®ˆå®®"}, {id: 255, name: "ç«ç¨šé›"}, {id: 258, name: "æ°´èºé­š"}, {id: 282, name: "æ²™å¥ˆæœµ"}, {id: 373, name: "æš´é£›é¾"}, {id: 376, name: "å·¨é‡‘æ€ª"}, {id: 384, name: "çƒˆç©ºå"}, {id: 385, name: "åŸºæ‹‰ç¥ˆ"},
            {id: 390, name: "å°ç«ç„°çŒ´"}, {id: 393, name: "æ³¢åŠ æ›¼"}, {id: 448, name: "è·¯å¡åˆ©æ­"}, {id: 470, name: "è‘‰ä¼Šå¸ƒ"}, {id: 471, name: "å†°ä¼Šå¸ƒ"}, {id: 493, name: "é˜¿çˆ¾å®™æ–¯"},
            {id: 495, name: "è—¤è—¤è›‡"}, {id: 501, name: "æ°´æ°´çº"}, {id: 571, name: "ç´¢ç¾…äºå…‹"}, {id: 609, name: "æ°´æ™¶ç‡ˆç«éˆ"},
            {id: 650, name: "å“ˆåŠ›æ —"}, {id: 653, name: "ç«ç‹ç‹¸"}, {id: 656, name: "å‘±å‘±æ³¡è›™"}, {id: 658, name: "ç”²è³€å¿è›™"}, {id: 700, name: "ä»™å­ä¼Šå¸ƒ"},
            {id: 722, name: "æœ¨æœ¨æ¢Ÿ"}, {id: 725, name: "ç«æ–‘å–µ"}, {id: 728, name: "çƒçƒæµ·ç…"}, {id: 778, name: "è¬æ“¬Q"}, {id: 791, name: "ç´¢çˆ¾è¿¦é›·æ­"}, {id: 792, name: "éœ²å¥ˆé›…æ‹‰"},
            {id: 810, name: "æ•²éŸ³çŒ´"}, {id: 813, name: "ç‚å…”å…’"}, {id: 816, name: "æ·šçœ¼èœ¥"}, {id: 888, name: "è’¼éŸ¿"}, {id: 889, name: "è—ç‘ªç„¶ç‰¹"},
            {id: 906, name: "æ–°è‘‰å–µ"}, {id: 909, name: "å‘†ç«é±·"}, {id: 912, name: "æ½¤æ°´é´¨"}, {id: 1008, name: "å¯†å‹’é “"}, {id: 1007, name: "æ•…å‹’é “"}
        ];

        let POKEMON_DB = [...CURATED_POKEMON];
        while(POKEMON_DB.length < 100) {
            POKEMON_DB.push(CURATED_POKEMON[Math.floor(Math.random() * CURATED_POKEMON.length)]);
        }
        POKEMON_DB = POKEMON_DB.slice(0, 100);

        window.caughtPokemon = new Set();
        let currentProblem = null;
        let currentPokemon = null;
        let mistakeCount = 0;
        const MAX_MISTAKES = 2;

        const gcd = (a, b) => b === 0 ? a : gcd(b, a % b);
        const lcm = (a, b) => (a * b) / gcd(a, b);
        const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

        function generateProblem() {
            let p = {};
            let isValid = false;
            let attempts = 0;
            const count = window.caughtPokemon.size;
            let minDen = 2, maxDen = count < 12 ? 12 : (count < 30 ? 30 : 99);

            while (!isValid && attempts < 500) {
                attempts++;
                p.d1 = randInt(minDen, maxDen); p.d2 = randInt(minDen, maxDen);
                if (p.d1 === p.d2) continue;
                p.n1 = randInt(1, p.d1 - 1); p.n2 = randInt(1, p.d2 - 1);
                p.op = Math.random() > 0.5 ? '+' : '-';
                if (p.op === '-') { if ((p.n1/p.d1) < (p.n2/p.d2)) [p.n1, p.d1, p.n2, p.d2] = [p.n2, p.d2, p.n1, p.d1]; }
                
                let gcd1 = gcd(p.n1, p.d1); let gcd2 = gcd(p.n2, p.d2);
                p.needsSimplify = (gcd1 > 1 || gcd2 > 1);
                p.s_n1 = p.n1 / gcd1; p.s_d1 = p.d1 / gcd1; p.s_n2 = p.n2 / gcd2; p.s_d2 = p.d2 / gcd2;

                let commonFactor = gcd(p.s_d1, p.s_d2);
                p.strategy = (commonFactor === 1) ? 'cross' : 'lcm';
                p.commonDenom = (commonFactor === 1) ? p.s_d1 * p.s_d2 : lcm(p.s_d1, p.s_d2);
                if (p.commonDenom >= 100) continue;

                p.c_n1 = p.s_n1 * (p.commonDenom / p.s_d1); p.c_n2 = p.s_n2 * (p.commonDenom / p.s_d2);
                let rawNum = (p.op === '+') ? (p.c_n1 + p.c_n2) : (p.c_n1 - p.c_n2);
                let finalGcd = gcd(rawNum, p.commonDenom);
                p.finalNum = rawNum / finalGcd; p.finalDen = p.commonDenom / finalGcd;
                isValid = true;
            }
            return p;
        }

        function saveGame() {
            const arr = Array.from(window.caughtPokemon);
            localStorage.setItem('poke_math_save_v2', JSON.stringify(arr));
            if (window.Cloud && window.Cloud.save) {
                window.Cloud.save(arr);
            }
            renderPC();
        }

        function loadLocalSave() {
            const saved = localStorage.getItem('poke_math_save_v2');
            if (saved) {
                window.caughtPokemon = new Set(JSON.parse(saved));
                renderPC();
            }
        }

        function init() {
            loadLocalSave();
            renderPC();
            document.getElementById('actionArea').innerHTML = `<button class="btn-action" onclick="spawnPokemon()">å°‹æ‰¾å¯¶å¯å¤¢</button>`;
            document.body.addEventListener('click', function resumeAudio() {
                if (audioCtx.state === 'suspended') audioCtx.resume();
            }, { once: true });
        }

        function spawnPokemon() {
            if (window.caughtPokemon.size >= 100) { showVictory(); return; }

            mistakeCount = 0; updateMistakeUI();
            let available = POKEMON_DB.filter(p => !window.caughtPokemon.has(p.id));
            if (available.length === 0) {
                if (window.caughtPokemon.size < 100) available = POKEMON_DB; 
                else { showVictory(); return; }
            }
            
            currentPokemon = available[Math.floor(Math.random() * available.length)];
            currentProblem = generateProblem();

            const img = document.getElementById('pokemonImg');
            img.src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${currentPokemon.id}.png`;
            img.className = "pokemon-img silhouette bounce";
            img.style.opacity = "1"; img.style.transform = "scale(1)";

            document.getElementById('problemCard').style.display = 'none';
            document.getElementById('dialogBox').innerHTML = `é‡ç”Ÿçš„ <span style="color:#FFCB05">???</span> å‡ºç¾äº†ï¼<br>æ°£å ´ä¼¼ä¹å¾ˆå¼·å¤§...`;
            document.getElementById('actionArea').innerHTML = `<button class="btn-action" onclick="startBattle()">æº–å‚™æˆ°é¬¥</button>`;

            if (isMusicOn) RetroBGM.play();
        }

        function startBattle() {
            document.getElementById('pokemonImg').classList.remove('silhouette');
            document.getElementById('problemCard').style.display = 'flex';
            renderProblemDisplay(currentProblem.n1, currentProblem.d1, currentProblem.n2, currentProblem.d2, currentProblem.op);
            document.getElementById('dialogBox').innerHTML = `æ˜¯ <b>${currentPokemon.name}</b>ï¼<br>è§€å¯Ÿé¡Œç›®ï¼Œéœ€è¦å…ˆã€Œç´„åˆ†ã€å—ï¼Ÿ`;
            document.getElementById('actionArea').innerHTML = `
                <button class="btn-action" onclick="checkSimplify(true)">éœ€è¦ç´„åˆ†</button>
                <button class="btn-action" onclick="checkSimplify(false)">ä¸éœ€ç´„åˆ†</button>
            `;
        }

        function handleMistake(msg) {
            Sound.playWrong(); mistakeCount++; updateMistakeUI();
            const screen = document.querySelector('.battle-screen');
            screen.classList.remove('shake-anim'); void screen.offsetWidth; screen.classList.add('shake-anim');

            if (mistakeCount >= MAX_MISTAKES) {
                Sound.playRunAway();
                RetroBGM.stop();
                document.getElementById('pokemonImg').classList.add('run-away');
                document.getElementById('problemCard').style.display = 'none';
                document.getElementById('dialogBox').innerHTML = `ç³Ÿç³•ï¼å¤±èª¤å¤ªå¤šæ¬¡ï¼<br><b>${currentPokemon.name}</b> é€ƒè·‘äº†ï¼`;
                document.getElementById('actionArea').innerHTML = `<button class="btn-action" onclick="spawnPokemon()">å°‹æ‰¾ä¸‹ä¸€éš»</button>`;
            } else {
                document.getElementById('dialogBox').innerHTML = `${msg}<br>å°å¿ƒï¼å†éŒ¯ä¸€æ¬¡å®ƒå°±æœƒé€ƒè·‘ï¼`;
            }
        }

        function updateMistakeUI() {
            document.getElementById('mistake1').className = mistakeCount >= 1 ? 'mistake-dot active' : 'mistake-dot';
            document.getElementById('mistake2').className = mistakeCount >= 2 ? 'mistake-dot active' : 'mistake-dot';
        }

        function checkSimplify(userChoice) {
            if (mistakeCount >= MAX_MISTAKES) return;
            if (userChoice === currentProblem.needsSimplify) {
                Sound.playCorrect();
                if (userChoice) {
                    document.getElementById('dialogBox').innerHTML = "åˆ¤æ–·æ­£ç¢ºï¼<br>è«‹è¼¸å…¥ç´„åˆ†å¾Œçš„ã€Œæœ€ç°¡åˆ†æ•¸ã€ï¼š";
                    renderInputMode('simplify');
                } else {
                    document.getElementById('dialogBox').innerHTML = "æ­£ç¢ºï¼é€™å·²ç¶“æ˜¯æœ€ç°¡åˆ†æ•¸ã€‚<br>æ¥è‘—é¸æ“‡é€šåˆ†ç­–ç•¥ï¼";
                    setTimeout(renderStrategyStep, 1000);
                }
            } else {
                handleMistake(userChoice ? "é€™é¡Œå·²ç¶“æœ€ç°¡å›‰ï¼Œä¸éœ€è¦ç´„åˆ†ã€‚" : "çœ‹ä»”ç´°ï¼é‚„æœ‰å…¬å› æ•¸å¯ä»¥ç´„åˆ†å–”ï¼");
            }
        }

        function renderStrategyStep() {
            const p = currentProblem;
            renderProblemDisplay(p.s_n1, p.s_d1, p.s_n2, p.s_d2, p.op);
            document.getElementById('dialogBox').innerHTML = "è«‹é¸æ“‡é€šåˆ†ç­–ç•¥ï¼š";
            document.getElementById('actionArea').innerHTML = `
                <button class="btn-action" onclick="checkStrategy('cross')">åˆ†æ¯äº’ä¹˜<br><small>(ç„¡å…¬å› æ•¸)</small></button>
                <button class="btn-action" onclick="checkStrategy('lcm')">æ‰¾æœ€å°å…¬å€æ•¸<br><small>(æœ‰å…¬å› æ•¸)</small></button>
            `;
        }

        function checkStrategy(choice) {
            if (mistakeCount >= MAX_MISTAKES) return;
            if (choice === currentProblem.strategy) {
                Sound.playCorrect();
                document.getElementById('dialogBox').innerHTML = "ç­–ç•¥æ­£ç¢ºï¼<br>è«‹ç®—å‡ºé€šåˆ†å¾Œçš„åˆ†å­åˆ†æ¯ï¼š";
                renderInputMode('common');
            } else {
                let hint = currentProblem.strategy === 'cross' ? "åˆ†æ¯æ²’æœ‰å…¬å› æ•¸å–”ï¼Œç›´æ¥äº’ä¹˜å§ï¼" : "åˆ†æ¯æœ‰å…¬å› æ•¸ï¼Œæ‰¾æœ€å°å…¬å€æ•¸æ•¸å­—æ¯”è¼ƒå°å–”ï¼";
                handleMistake("ç­–ç•¥é¸éŒ¯å›‰ï¼<br>" + hint);
            }
        }

        function renderInputMode(mode) {
            const p = currentProblem;
            document.getElementById('actionArea').innerHTML = `
                <div class="input-mode-container">
                    <div class="fraction"><div class="numerator"><input type="number" id="i_n1"></div><div class="denominator"><input type="number" id="i_d1"></div></div>
                    <span style="font-size:1.5rem; margin:0 5px;">${p.op}</span>
                    <div class="fraction"><div class="numerator"><input type="number" id="i_n2"></div><div class="denominator"><input type="number" id="i_d2"></div></div>
                    <button class="btn-action" onclick="verifyInput('${mode}')">æ”»æ“Šï¼</button>
                </div>
            `;
        }

        function verifyInput(mode) {
            if (mistakeCount >= MAX_MISTAKES) return;
            const n1 = parseInt(document.getElementById('i_n1').value), d1 = parseInt(document.getElementById('i_d1').value);
            const n2 = parseInt(document.getElementById('i_n2').value), d2 = parseInt(document.getElementById('i_d2').value);
            const p = currentProblem;

            let isCorrect = false;
            if (mode === 'simplify') isCorrect = (n1 === p.s_n1 && d1 === p.s_d1 && n2 === p.s_n2 && d2 === p.s_d2);
            else if (mode === 'common') isCorrect = (d1 === p.commonDenom && d2 === p.commonDenom && n1 === p.c_n1 && n2 === p.c_n2);

            if (isCorrect) {
                Sound.playCorrect();
                if (mode === 'simplify') {
                    document.getElementById('dialogBox').innerHTML = "ç´„åˆ†æˆåŠŸï¼é˜²ç¦¦é™ä½äº†ï¼<br>æ¥è‘—é¸æ“‡é€šåˆ†ç­–ç•¥ï¼";
                    setTimeout(renderStrategyStep, 1000);
                } else {
                    document.getElementById('dialogBox').innerHTML = "é€šåˆ†æˆåŠŸï¼è¦å®³å‡ºç¾ï¼<br>è¨ˆç®—æœ€å¾Œç­”æ¡ˆä¸¦ä¸Ÿå‡ºç²¾éˆçƒï¼<br><span style='font-size:0.8rem; color:#FFFF00'>(è«‹æª¢å¯Ÿè¼¸å…¥çš„ç­”æ¡ˆæ˜¯å¦å·²ç‚ºä¸èƒ½å†ç´„åˆ†çš„åˆ†æ•¸)</span>";
                    setTimeout(renderFinalStep, 1000);
                }
            } else {
                handleMistake("æ•¸å­—ç®—éŒ¯å›‰ï¼è«‹å†æª¢æŸ¥ä¸€æ¬¡è¨ˆç®—ã€‚");
            }
        }

        function renderFinalStep() {
            const p = currentProblem;
            renderProblemDisplay(p.c_n1, p.commonDenom, p.c_n2, p.commonDenom, p.op);
            document.getElementById('actionArea').innerHTML = `
                <div class="input-mode-container">
                    <span style="font-weight:bold; margin-right:10px;">ç­”æ¡ˆï¼š</span>
                    <div class="fraction"><div class="numerator"><input type="number" id="f_n"></div><div class="denominator"><input type="number" id="f_d"></div></div>
                    <button class="btn-action" style="background:#FF3E3E; color:white;" onclick="verifyFinal()">ä¸Ÿçƒï¼</button>
                </div>
            `;
        }

        function verifyFinal() {
            if (mistakeCount >= MAX_MISTAKES) return;
            const n = parseInt(document.getElementById('f_n').value), d = parseInt(document.getElementById('f_d').value);
            const p = currentProblem;

            if (n === p.finalNum && d === p.finalDen) {
                Sound.playThrow();
                RetroBGM.stop();
                const ball = document.getElementById('pokeballThrow'), pkm = document.getElementById('pokemonImg');
                ball.style.display = 'block'; ball.style.top = '50%'; ball.style.left = '50%'; ball.style.transform = 'translate(-50%, -50%) scale(0.5)';
                ball.animate([{ top: '50%', transform: 'translate(-50%, -50%) scale(0.5)' }, { top: '30%', transform: 'translate(-50%, -50%) scale(1)' }], { duration: 500, fill: 'forwards' }).onfinish = () => {
                    pkm.classList.add('captured');
                    setTimeout(() => {
                        Sound.playCaught(); ball.style.display = 'none'; 
                        window.caughtPokemon.add(currentPokemon.id);
                        saveGame(); 
                        document.getElementById('dialogBox').innerHTML = `å¤ªæ£’äº†ï¼<br>æˆåŠŸæ”¶æœ <b>${currentPokemon.name}</b>ï¼`;
                        document.getElementById('problemCard').style.display = 'none';
                        document.getElementById('actionArea').innerHTML = `<button class="btn-action" onclick="spawnPokemon()">ä¸‹ä¸€éš»</button>`;
                    }, 1000);
                };
            } else {
                handleMistake("ç­”æ¡ˆéŒ¯èª¤ï¼ç²¾éˆçƒå½ˆé–‹äº†ï¼<br><span style='font-size:0.9rem'>(è«‹æª¢å¯Ÿè¼¸å…¥çš„ç­”æ¡ˆæ˜¯å¦å·²ç‚ºä¸èƒ½å†ç´„åˆ†çš„åˆ†æ•¸)</span>");
            }
        }

        function renderProblemDisplay(n1, d1, n2, d2, op) {
            document.getElementById('problemCard').innerHTML = `
                <div class="fraction"><div class="numerator">${n1}</div><div class="denominator">${d1}</div></div>
                <div style="margin:0 5px">${op}</div>
                <div class="fraction"><div class="numerator">${n2}</div><div class="denominator">${d2}</div></div>
                <div style="margin-left:5px">= ?</div>
            `;
        }

        window.renderPC = function() {
            const grid = document.getElementById('pcGrid'); 
            grid.innerHTML = '';
            document.getElementById('caughtCount').innerText = window.caughtPokemon.size;
            POKEMON_DB.forEach(pkm => {
                const isCaught = window.caughtPokemon.has(pkm.id);
                const div = document.createElement('div'); 
                div.className = `grid-item ${isCaught ? 'caught' : 'unknown'}`;
                div.innerHTML = `<img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${pkm.id}.png" loading="lazy"><div class="name-tag">${isCaught ? pkm.name : '???'}</div>`;
                grid.appendChild(div);
            });
        }

        function showVictory() { document.getElementById('victoryModal').style.display = 'flex'; Sound.playCaught(); }

        // å•Ÿå‹•éŠæˆ²
        try {
            init();
        } catch(e) {
            console.error(e);
            alert("éŠæˆ²åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢ã€‚");
        }
    </script>
</body>
</html>
